theme(axis.title.y=element_blank())+
scale_fill_gradient(low="white", high="#004488")
pc
dev.off()
pdf("Top25families_DLAB.pdf", bg ="white", width=8.5)
pd <- ggplot(famplotD, aes(sample, Family, fill= proportion)) + geom_tile()+
facet_grid(.~timepoint,scales="free",space="free")+
theme(axis.text.x=element_text(angle=90))+
#theme(axis.text.y=element_text(face="italic"))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())+
scale_fill_gradient(low="white", high="#004488")
pd
dev.off()
library(dada2)
library(phyloseq)
library(CoDaSeq)
library(vegan)
library(pairwiseAdonis)
library(corncob)
library(ggplot2)
library(randomcoloR)
library(cowplot)
library(knitr)
library(dplyr)
library(reshape2)
library(tibble)
writeLines(capture.output(sessionInfo()), "sessionInfo.txt")
otu <- read.table("silva_nochloronomito_otu_table_ps2_RA.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps2.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps2.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps2_ra <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps2_ra
get_taxa_unique(ps2_ra, "Family") # 46 families
ps2_ra_f = tax_glom(ps2_ra, "Family")
ps2_ra_f # 46 families and 152 samples
otu_f = as(otu_table(ps2_ra_f), "matrix")
taxon_f = as(tax_table(ps2_ra_f), "matrix")
fam<-t(otu_f)
fam <- as.data.frame(fam)
fam <- tibble::rownames_to_column(fam, "ASV")
taxon_f <- as.data.frame(taxon_f)
taxon_f <- tibble::rownames_to_column(taxon_f, "ASV")
fam_tax <- merge(fam, taxon_f, by="ASV", all=TRUE)
fam_tax$Genus<-NULL
fam_tax$ASV<-NULL
# Order by total relative abundance and choose top 25 families
fam_tax <- fam_tax %>% mutate("total" = rowSums((fam_tax[,1:152]), na.rm = TRUE))
fam_tax <- fam_tax[order(fam_tax$total, decreasing = TRUE),]
fam25 <- fam_tax[1:25,]
fam25$total<-NULL
fam_long<-melt(fam25,value.name="proportion",variable.name="sample",id.vars=c("Kingdom","Phylum","Class","Order","Family"))
# Merge with metadata for plotting aesthetics
samples <- as.data.frame(samples)
samples <- tibble::rownames_to_column(samples, "sample")
famplot <- merge(fam_long,samples,by="sample", all=TRUE)
famplotC <- famplot %>% filter(coral.species =='Colpophyllia natans')
famplotD <- famplot %>% filter(coral.species =='Diploria labyrinthiformis')
# set aesthetics for each coral species
famplotC$timepoint<-factor(famplotC$timepoint,levels=c("Initial","2-month"))
famplotC$Family<-factor(famplotC$Family,levels=c("Bacteroidia","Burkholderiaceae","Rhodospirillaceae","Paraspirulinaceae","AB1","Alphaproteobacteria","Kiloniellaceae","Bacteria","Fusibacteraceae","Woeseiaceae","Endozoicomonadaceae","Desulfocapsaceae","Desulfovibrionaceae","Nitrosopumilaceae","Cyanobacteriaceae","Phormidiaceae","Campylobacterales","Hyphomonadaceae","Flavobacteriaceae","Blastocatellaceae","Paracoccaceae","Terasakiellaceae","Vibrionaceae","Amoebophilaceae","Ga0077536"))
famplotD$timepoint<-factor(famplotD$timepoint,levels=c("Initial","2-month"))
famplotD$Family<-factor(famplotD$Family,levels=c("Bacteroidia","Burkholderiaceae","Rhodospirillaceae","Paraspirulinaceae","AB1","Alphaproteobacteria","Kiloniellaceae","Bacteria","Fusibacteraceae","Woeseiaceae","Endozoicomonadaceae","Desulfocapsaceae","Desulfovibrionaceae","Nitrosopumilaceae","Cyanobacteriaceae","Phormidiaceae","Campylobacterales","Hyphomonadaceae","Flavobacteriaceae","Blastocatellaceae","Paracoccaceae","Terasakiellaceae","Vibrionaceae","Amoebophilaceae","Ga0077536"))
pc <- ggplot(famplotC, aes(sample, Family, fill= proportion)) + geom_tile()+
facet_grid(.~timepoint,scales="free",space="free")+
theme(axis.text.x=element_text(angle=90))+
#theme(axis.text.y=element_text(face="italic"))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())+
scale_fill_gradient(low="white", high="#004488")
pc
View(famplotC)
pc <- ggplot(famplotC, aes(sample, Family, fill= proportion))+
geom_point(aes(size=proportion*100),alpha=0.9,shape=21)+
facet_grid(.~timepoint,scales="free",space="free")+
theme(axis.text.x=element_text(angle=90))+
#theme(axis.text.y=element_text(face="italic"))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())+
scale_fill_gradient(low="white", high="#004488")
pc
pc <- ggplot(famplotC, aes(sample, Family, fill= proportion))+
geom_point(aes(size=proportion*100),alpha=0.9,shape=21)+
facet_grid(.~timepoint,scales="free",space="free")+
theme(axis.text.x=element_text(angle=90))+
#theme(axis.text.y=element_text(face="italic"))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pc
pc <- ggplot(famplotC, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.9,shape=21)+
facet_grid(.~timepoint,scales="free",space="free")+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pc
pc <- ggplot(famplotC, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pc
otu <- read.table("silva_nochloronomito_otu_table_ps2_RA.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps2.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps2.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps2_ra <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps2_ra # 89 taxa and 152 samples
get_taxa_unique(ps2_ra, "Family") # 46 families
# Plotting most abundant families - first collapse ASVs into families then reshape data for plotting
ps2_ra_f = tax_glom(ps2_ra, "Family")
ps2_ra_f # 46 families and 152 samples
otu_f = as(otu_table(ps2_ra_f), "matrix")
taxon_f = as(tax_table(ps2_ra_f), "matrix")
fam<-t(otu_f)
fam <- as.data.frame(fam)
fam <- tibble::rownames_to_column(fam, "ASV")
taxon_f <- as.data.frame(taxon_f)
taxon_f <- tibble::rownames_to_column(taxon_f, "ASV")
fam_tax <- merge(fam, taxon_f, by="ASV", all=TRUE)
fam_tax$Genus<-NULL
fam_tax$ASV<-NULL
# Order by total relative abundance and choose top 25 families
fam_tax <- fam_tax %>% mutate("total" = rowSums((fam_tax[,1:152]), na.rm = TRUE))
fam_tax <- fam_tax[order(fam_tax$total, decreasing = TRUE),]
fam25 <- fam_tax[1:25,]
fam25$total<-NULL
fam_long<-melt(fam25,value.name="proportion",variable.name="sample",id.vars=c("Kingdom","Phylum","Class","Order","Family"))
# Merge with metadata for plotting aesthetics
samples <- as.data.frame(samples)
samples <- tibble::rownames_to_column(samples, "sample")
famplot <- merge(fam_long,samples,by="sample", all=TRUE)
# separate by coral species
famplotC <- famplot %>% filter(coral.species =='Colpophyllia natans')
famplotD <- famplot %>% filter(coral.species =='Diploria labyrinthiformis')
famplotC$timepoint<-factor(famplotC$timepoint,levels=c("Initial","2-month"))
famplotC$Family<-factor(famplotC$Family,levels=c("Bacteroidia","Burkholderiaceae","Rhodospirillaceae","Paraspirulinaceae","AB1","Alphaproteobacteria","Kiloniellaceae","Bacteria","Fusibacteraceae","Woeseiaceae","Endozoicomonadaceae","Desulfocapsaceae","Desulfovibrionaceae","Nitrosopumilaceae","Cyanobacteriaceae","Phormidiaceae","Campylobacterales","Hyphomonadaceae","Flavobacteriaceae","Blastocatellaceae","Paracoccaceae","Terasakiellaceae","Vibrionaceae","Amoebophilaceae","Ga0077536"))
#set colorblind friendly palette, this is muted_nine plus black and white
cols<-c("Alphaproteobacteria"="#332288","Bacteria"="#117733","Bacteroidia"="#CC6677","
Blastocatellia"="#88CCEE","Campylobacteria"="#999933","Clostridia"="#882255","Cyanobacteriia"="#44AA99","Desulfobulbia"="#DDCC77","Desulfovibrionia"="#AA4499","Gammaproteobacteria"="#000000","Nitrosphaeria"="#F9F4EC")
pc <- ggplot(famplotC, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pc
pc <- ggplot(famplotC, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
scale_fill_manual(values = cols)+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pc
get_taxa_unique(famplotC, "Class")
unique(famplotC$Class)
unique(famplotD$Class)
otu <- read.table("silva_nochloronomito_otu_table_ps2_RA.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps2.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps2.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps2_ra <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps2_ra # 89 taxa and 152 samples
get_taxa_unique(ps2_ra, "Family") # 46 families
# Plotting most abundant families - first collapse ASVs into families then reshape data for plotting
ps2_ra_f = tax_glom(ps2_ra, "Family")
ps2_ra_f # 46 families and 152 samples
otu_f = as(otu_table(ps2_ra_f), "matrix")
taxon_f = as(tax_table(ps2_ra_f), "matrix")
fam<-t(otu_f)
fam <- as.data.frame(fam)
fam <- tibble::rownames_to_column(fam, "ASV")
taxon_f <- as.data.frame(taxon_f)
taxon_f <- tibble::rownames_to_column(taxon_f, "ASV")
fam_tax <- merge(fam, taxon_f, by="ASV", all=TRUE)
fam_tax$Genus<-NULL
fam_tax$ASV<-NULL
# Order by total relative abundance and choose top 25 families
fam_tax <- fam_tax %>% mutate("total" = rowSums((fam_tax[,1:152]), na.rm = TRUE))
fam_tax <- fam_tax[order(fam_tax$total, decreasing = TRUE),]
fam25 <- fam_tax[1:25,]
fam25$total<-NULL
fam_long<-melt(fam25,value.name="proportion",variable.name="sample",id.vars=c("Kingdom","Phylum","Class","Order","Family"))
# Merge with metadata for plotting aesthetics
samples <- as.data.frame(samples)
samples <- tibble::rownames_to_column(samples, "sample")
famplot <- merge(fam_long,samples,by="sample", all=TRUE)
# separate by coral species
famplotC <- famplot %>% filter(coral.species =='Colpophyllia natans')
unique(famplotC$Class) # 11 classes
# [1] "Gammaproteobacteria" "Bacteroidia"         "Alphaproteobacteria" "Blastocatellia"      "Campylobacteria"
# [6] "Cyanobacteriia"      "Nitrososphaeria"     "Desulfovibrionia"    "Desulfobulbia"       "Clostridia"
# [11] "Bacteria"
famplotD <- famplot %>% filter(coral.species =='Diploria labyrinthiformis')
unique(famplotD$Class) # same 11 classes as above
#set colorblind friendly palette, this is muted_nine plus black and white
cols<-c("Alphaproteobacteria"="#332288","Bacteria"="#117733","Bacteroidia"="#CC6677","
Blastocatellia"="#88CCEE","Campylobacteria"="#999933","Clostridia"="#882255","Cyanobacteriia"="#44AA99","Desulfobulbia"="#DDCC77","Desulfovibrionia"="#AA4499","Gammaproteobacteria"="#000000","Nitrosphaeria"="#F9F4EC")
# set aesthetics for each coral species
famplotC$timepoint<-factor(famplotC$timepoint,levels=c("Initial","2-month"))
famplotC$Family<-factor(famplotC$Family,levels=c("Bacteroidia","Burkholderiaceae","Rhodospirillaceae","Paraspirulinaceae","AB1","Alphaproteobacteria","Kiloniellaceae","Bacteria","Fusibacteraceae","Woeseiaceae","Endozoicomonadaceae","Desulfocapsaceae","Desulfovibrionaceae","Nitrosopumilaceae","Cyanobacteriaceae","Phormidiaceae","Campylobacterales","Hyphomonadaceae","Flavobacteriaceae","Blastocatellaceae","Paracoccaceae","Terasakiellaceae","Vibrionaceae","Amoebophilaceae","Ga0077536"))
famplotD$timepoint<-factor(famplotD$timepoint,levels=c("Initial","2-month"))
famplotD$Family<-factor(famplotD$Family,levels=c("Bacteroidia","Burkholderiaceae","Rhodospirillaceae","Paraspirulinaceae","AB1","Alphaproteobacteria","Kiloniellaceae","Bacteria","Fusibacteraceae","Woeseiaceae","Endozoicomonadaceae","Desulfocapsaceae","Desulfovibrionaceae","Nitrosopumilaceae","Cyanobacteriaceae","Phormidiaceae","Campylobacterales","Hyphomonadaceae","Flavobacteriaceae","Blastocatellaceae","Paracoccaceae","Terasakiellaceae","Vibrionaceae","Amoebophilaceae","Ga0077536"))
pc <- ggplot(famplotC, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
scale_fill_manual(values = cols)+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pc
pd <- ggplot(famplotD, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
scale_fill_manual(values = cols)+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pd
#set colorblind friendly palette, this is muted_nine plus black and white
cols<-c("Alphaproteobacteria"="#332288","Bacteria"="#117733","Bacteroidia"="#CC6677","Blastocatellia"="#88CCEE","Campylobacteria"="#999933","Clostridia"="#882255","Cyanobacteriia"="#44AA99","Desulfobulbia"="#DDCC77","Desulfovibrionia"="#AA4499","Gammaproteobacteria"="#000000","Nitrososphaeria"="#F9F4EC")
# set aesthetics for each coral species
famplotC$timepoint<-factor(famplotC$timepoint,levels=c("Initial","2-month"))
famplotC$Family<-factor(famplotC$Family,levels=c("Bacteroidia","Burkholderiaceae","Rhodospirillaceae","Paraspirulinaceae","AB1","Alphaproteobacteria","Kiloniellaceae","Bacteria","Fusibacteraceae","Woeseiaceae","Endozoicomonadaceae","Desulfocapsaceae","Desulfovibrionaceae","Nitrosopumilaceae","Cyanobacteriaceae","Phormidiaceae","Campylobacterales","Hyphomonadaceae","Flavobacteriaceae","Blastocatellaceae","Paracoccaceae","Terasakiellaceae","Vibrionaceae","Amoebophilaceae","Ga0077536"))
famplotD$timepoint<-factor(famplotD$timepoint,levels=c("Initial","2-month"))
famplotD$Family<-factor(famplotD$Family,levels=c("Bacteroidia","Burkholderiaceae","Rhodospirillaceae","Paraspirulinaceae","AB1","Alphaproteobacteria","Kiloniellaceae","Bacteria","Fusibacteraceae","Woeseiaceae","Endozoicomonadaceae","Desulfocapsaceae","Desulfovibrionaceae","Nitrosopumilaceae","Cyanobacteriaceae","Phormidiaceae","Campylobacterales","Hyphomonadaceae","Flavobacteriaceae","Blastocatellaceae","Paracoccaceae","Terasakiellaceae","Vibrionaceae","Amoebophilaceae","Ga0077536"))
pc <- ggplot(famplotC, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
scale_fill_manual(values = cols)+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pc
cols<-c("Alphaproteobacteria"="#CC6677","Bacteria"="#117733","Bacteroidia"="#332288","Blastocatellia"="#88CCEE","Campylobacteria"="#999933","Clostridia"="#882255","Cyanobacteriia"="#44AA99","Desulfobulbia"="#DDCC77","Desulfovibrionia"="#AA4499","Gammaproteobacteria"="#000000","Nitrososphaeria"="#F9F4EC")
pc <- ggplot(famplotC, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
scale_fill_manual(values = cols)+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pc
pd <- ggplot(famplotD, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
scale_fill_manual(values = cols)+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pd
View(famplot)
View(fam25)
View(fam_tax)
# add a column to show all other families not included in the top 25 (21 other families)
fam25_others<-rbind(fam25, c("Others",colSums(fam25[,1:152])))
View(fam_tax)
otu <- read.table("silva_nochloronomito_otu_table_ps2_RA.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps2.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps2.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps2_ra <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps2_ra # 89 taxa and 152 samples
get_taxa_unique(ps2_ra, "Family") # 46 families
# Plotting most abundant families - first collapse ASVs into families then reshape data for plotting
ps2_ra_f = tax_glom(ps2_ra, "Family")
ps2_ra_f # 46 families and 152 samples
otu_f = as(otu_table(ps2_ra_f), "matrix")
taxon_f = as(tax_table(ps2_ra_f), "matrix")
fam<-t(otu_f)
fam <- as.data.frame(fam)
fam <- tibble::rownames_to_column(fam, "ASV")
taxon_f <- as.data.frame(taxon_f)
taxon_f <- tibble::rownames_to_column(taxon_f, "ASV")
fam_tax <- merge(fam, taxon_f, by="ASV", all=TRUE)
View(fam_tax)
fam_tax$Genus<-NULL
fam_tax$ASV<-NULL
# Order by total relative abundance and choose top 25 families
fam_tax <- fam_tax %>% mutate("total" = rowSums((fam_tax[,1:152]), na.rm = TRUE))
View(fam_tax)
fam_tax <- fam_tax[order(fam_tax$total, decreasing = TRUE),]
fam25 <- fam_tax[1:25,]
fam25$total<-NULL
# calculate a row with the relative abundance of all other families not included in the top 25 (21 other families), first remove taxonomy
fam25_other<-fam25[1:152]
View(fam25_other)
fam25_others<-rbind(fam25_other, c("Others",colSums(fam25_other[,1:152])))
fam25_others<-rbind(fam25_other, colSums(fam25_other[,1:152]))
View(fam25_others)
otu <- read.table("silva_nochloronomito_otu_table_ps2_RA.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps2.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps2.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps2_ra <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps2_ra # 89 taxa and 152 samples
get_taxa_unique(ps2_ra, "Family") # 46 families
# Plotting most abundant families - first collapse ASVs into families then reshape data for plotting
ps2_ra_f = tax_glom(ps2_ra, "Family")
ps2_ra_f # 46 families and 152 samples
otu_f = as(otu_table(ps2_ra_f), "matrix")
taxon_f = as(tax_table(ps2_ra_f), "matrix")
fam<-t(otu_f)
fam <- as.data.frame(fam)
fam <- tibble::rownames_to_column(fam, "ASV")
taxon_f <- as.data.frame(taxon_f)
taxon_f <- tibble::rownames_to_column(taxon_f, "ASV")
fam_tax <- merge(fam, taxon_f, by="ASV", all=TRUE)
fam_tax$Genus<-NULL
fam_tax$ASV<-NULL
# Order by total relative abundance and choose top 25 families
fam_tax <- fam_tax %>% mutate("total" = rowSums((fam_tax[,1:152]), na.rm = TRUE))
fam_tax <- fam_tax[order(fam_tax$total, decreasing = TRUE),]
fam25 <- fam_tax[1:25,]
fam25$total<-NULL
# calculate a row with the relative abundance of all other families not included in the top 25 (21 other families), first remove taxonomy
fam25_just25<-fam25[1:152]
fam25_25total<-rbind(fam25_just25, colSums(fam25_just25[,1:152]))
View(fam25_25total)
fam25_others<-rbind(fam25_25total, 1-fam25_25total[26,])
View(fam25_others)
test<-rbind(fam25, colSums(fam25[,1:152]))
# add "Others" as value for 5 taxonomy columns
fam25_others$Kingdom = "Others"
View(fam25_others)
View(fam25)
# finally, add only the last row back to the original dataframe fam25
fam25_withothers<-rbind(fam25, fam25_others[27,])
View(fam25_others)
# remove all but the last row
others<-fam25_others[-1:26,]
# remove all but the last row
others<-fam25_others[-(1:26),]
View(others)
otu <- read.table("silva_nochloronomito_otu_table_ps2_RA.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps2.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps2.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps2_ra <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps2_ra # 89 taxa and 152 samples
get_taxa_unique(ps2_ra, "Family") # 46 families
# Plotting most abundant families - first collapse ASVs into families then reshape data for plotting
ps2_ra_f = tax_glom(ps2_ra, "Family")
ps2_ra_f # 46 families and 152 samples
otu_f = as(otu_table(ps2_ra_f), "matrix")
taxon_f = as(tax_table(ps2_ra_f), "matrix")
fam<-t(otu_f)
fam <- as.data.frame(fam)
fam <- tibble::rownames_to_column(fam, "ASV")
taxon_f <- as.data.frame(taxon_f)
taxon_f <- tibble::rownames_to_column(taxon_f, "ASV")
fam_tax <- merge(fam, taxon_f, by="ASV", all=TRUE)
fam_tax$Genus<-NULL
fam_tax$ASV<-NULL
# Order by total relative abundance and choose top 25 families
fam_tax <- fam_tax %>% mutate("total" = rowSums((fam_tax[,1:152]), na.rm = TRUE))
fam_tax <- fam_tax[order(fam_tax$total, decreasing = TRUE),]
fam25 <- fam_tax[1:25,]
fam25$total<-NULL
# calculate a row with the relative abundance of all other families not included in the top 25 (21 other families), first remove taxonomy
fam25_just25<-fam25[1:152]
# next add up the relative abundances of the top 25 families
fam25_25total<-rbind(fam25_just25, colSums(fam25_just25[,1:152]))
# calculate what is the relative abundance of the other families
fam25_others<-rbind(fam25_25total, 1-fam25_25total[26,])
# add "Others" as value for 5 taxonomy columns
fam25_others$Kingdom = "Others"
fam25_others$Phylum = "Others"
fam25_others$Class = "Others"
fam25_others$Order = "Others"
fam25_others$Family = "Others"
# remove all but the last row
others<-fam25_others[-(1:26),]
View(fam25)
View(others)
# finally, add only the last row back to the original dataframe fam25
fam25_withothers <- rbind(fam25, others)
View(fam25_withothers)
fam_long<-melt(fam25_withothers,value.name="proportion",variable.name="sample",id.vars=c("Kingdom","Phylum","Class","Order","Family"))
# Merge with metadata for plotting aesthetics
samples <- as.data.frame(samples)
samples <- tibble::rownames_to_column(samples, "sample")
famplot <- merge(fam_long,samples,by="sample", all=TRUE)
famplotC <- famplot %>% filter(coral.species =='Colpophyllia natans')
unique(famplotC$Class)
famplotD <- famplot %>% filter(coral.species =='Diploria labyrinthiformis')
unique(famplotD$Class)
#set colorblind friendly palette, this is muted_nine plus black and white
cols<-c("Alphaproteobacteria"="#CC6677","Bacteria"="#117733","Bacteroidia"="#332288","Blastocatellia"="#88CCEE","Campylobacteria"="#999933","Clostridia"="#882255","Cyanobacteriia"="#44AA99","Desulfobulbia"="#DDCC77","Desulfovibrionia"="#AA4499","Gammaproteobacteria"="#000000","Nitrososphaeria"="#F9F4EC","Others"="#999999")
famplotC$timepoint<-factor(famplotC$timepoint,levels=c("Initial","2-month"))
famplotC$Family<-factor(famplotC$Family,levels=c("Others","Bacteroidia","Burkholderiaceae","Rhodospirillaceae","Paraspirulinaceae","AB1","Alphaproteobacteria","Kiloniellaceae","Bacteria","Fusibacteraceae","Woeseiaceae","Endozoicomonadaceae","Desulfocapsaceae","Desulfovibrionaceae","Nitrosopumilaceae","Cyanobacteriaceae","Phormidiaceae","Campylobacterales","Hyphomonadaceae","Flavobacteriaceae","Blastocatellaceae","Paracoccaceae","Terasakiellaceae","Vibrionaceae","Amoebophilaceae","Ga0077536"))
famplotD$timepoint<-factor(famplotD$timepoint,levels=c("Initial","2-month"))
famplotD$Family<-factor(famplotD$Family,levels=c("Others","Bacteroidia","Burkholderiaceae","Rhodospirillaceae","Paraspirulinaceae","AB1","Alphaproteobacteria","Kiloniellaceae","Bacteria","Fusibacteraceae","Woeseiaceae","Endozoicomonadaceae","Desulfocapsaceae","Desulfovibrionaceae","Nitrosopumilaceae","Cyanobacteriaceae","Phormidiaceae","Campylobacterales","Hyphomonadaceae","Flavobacteriaceae","Blastocatellaceae","Paracoccaceae","Terasakiellaceae","Vibrionaceae","Amoebophilaceae","Ga0077536"))
pc <- ggplot(famplotC, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
scale_fill_manual(values = cols)+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pc
pdf("Top25families_CNAT.pdf", bg ="white", width=8.5)
pc <- ggplot(famplotC, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
scale_fill_manual(values = cols)+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pc
dev.off()
pdf("Top25families_DLAB.pdf", bg ="white", width=8.5)
pd <- ggplot(famplotD, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
scale_fill_manual(values = cols)+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pd
dev.off()
pdf("Top25families_CNAT.pdf", bg ="white", width=10)
pc <- ggplot(famplotC, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
scale_fill_manual(values = cols)+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pc
dev.off()
pdf("Top25families_CNAT.pdf", bg ="white", width=11)
pc <- ggplot(famplotC, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
scale_fill_manual(values = cols)+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pc
dev.off()
pdf("Top25families_DLAB.pdf", bg ="white", width=11)
pd <- ggplot(famplotD, aes(sample, Family, fill= Class))+
geom_point(aes(size=proportion*100),alpha=0.8,shape=21)+
scale_size(range = c(0,10), name="Relative abundance")+
scale_fill_manual(values = cols)+
facet_grid(.~timepoint,scales="free",space="free")+
theme_bw()+
theme(axis.text.x=element_text(angle=90))+
theme(axis.title.x=element_blank())+
theme(axis.title.y=element_blank())
pd
dev.off()
